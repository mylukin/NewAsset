<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.asset.mapper.AssetMaintPlanMapper">

    <!-- Result map for list/detail view -->
    <resultMap id="MaintPlanResult" type="com.ruoyi.asset.domain.vo.AssetMaintPlanVO">
        <id property="id" column="id"/>
        <result property="planName" column="plan_name"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="assetType" column="asset_type"/>
        <result property="assetTypeLabel" column="asset_type_label"/>
        <result property="assetCategory" column="asset_category"/>
        <result property="cycleType" column="cycle_type"/>
        <result property="cycleTypeLabel" column="cycle_type_label"/>
        <result property="nextGenerateTime" column="next_generate_time"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="remark" column="remark"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="assetCount" column="asset_count"/>
    </resultMap>

    <!-- Query maintenance plan list with filters -->
    <select id="selectMaintPlanList" parameterType="com.ruoyi.asset.mapper.AssetMaintPlanMapper$MaintPlanQuery" resultMap="MaintPlanResult">
        SELECT
            mp.id,
            mp.plan_name,
            mp.project_id,
            p.project_name,
            mp.asset_type,
            dat.dict_label as asset_type_label,
            mp.asset_category,
            mp.cycle_type,
            dct.dict_label as cycle_type_label,
            mp.next_generate_time,
            mp.status,
            ds.dict_label as status_label,
            mp.remark,
            mp.create_by,
            mp.create_time,
            (SELECT COUNT(*) FROM t_asset_maint_plan_asset mpa WHERE mpa.plan_id = mp.id) as asset_count
        FROM t_asset_maint_plan mp
        LEFT JOIN sys_project p ON mp.project_id = p.id
        LEFT JOIN sys_dict_data dat ON dat.dict_type = 'asset_type' AND dat.dict_value = mp.asset_type
        LEFT JOIN sys_dict_data dct ON dct.dict_type = 'maint_cycle_type' AND dct.dict_value = mp.cycle_type
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'maint_plan_status' AND ds.dict_value = mp.status
        <where>
            <if test="projectId != null">
                AND mp.project_id = #{projectId}
            </if>
            <if test="assetType != null and assetType != ''">
                AND mp.asset_type = #{assetType}
            </if>
            <if test="assetCategory != null and assetCategory != ''">
                AND mp.asset_category = #{assetCategory}
            </if>
            <if test="cycleType != null and cycleType != ''">
                AND mp.cycle_type = #{cycleType}
            </if>
            <if test="status != null and status != ''">
                AND mp.status = #{status}
            </if>
            <if test="planName != null and planName != ''">
                AND mp.plan_name LIKE CONCAT('%', #{planName}, '%')
            </if>
            <!-- Data scope filtering -->
            <if test="dataScope != null and dataScope != ''">
                ${dataScope}
            </if>
        </where>
        ORDER BY mp.create_time DESC
    </select>

    <!-- Query maintenance plan detail by ID -->
    <select id="selectMaintPlanById" parameterType="java.lang.Long" resultMap="MaintPlanResult">
        SELECT
            mp.id,
            mp.plan_name,
            mp.project_id,
            p.project_name,
            mp.asset_type,
            dat.dict_label as asset_type_label,
            mp.asset_category,
            mp.cycle_type,
            dct.dict_label as cycle_type_label,
            mp.next_generate_time,
            mp.status,
            ds.dict_label as status_label,
            mp.remark,
            mp.create_by,
            mp.create_time,
            (SELECT COUNT(*) FROM t_asset_maint_plan_asset mpa WHERE mpa.plan_id = mp.id) as asset_count
        FROM t_asset_maint_plan mp
        LEFT JOIN sys_project p ON mp.project_id = p.id
        LEFT JOIN sys_dict_data dat ON dat.dict_type = 'asset_type' AND dat.dict_value = mp.asset_type
        LEFT JOIN sys_dict_data dct ON dct.dict_type = 'maint_cycle_type' AND dct.dict_value = mp.cycle_type
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'maint_plan_status' AND ds.dict_value = mp.status
        WHERE mp.id = #{id}
    </select>

    <!-- Insert maintenance plan -->
    <insert id="insertMaintPlan" parameterType="com.ruoyi.asset.domain.entity.AssetMaintPlan" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_asset_maint_plan (
            plan_name,
            project_id,
            asset_type,
            asset_category,
            cycle_type,
            next_generate_time,
            status,
            remark,
            create_by,
            create_time
        ) VALUES (
            #{planName},
            #{projectId},
            #{assetType},
            #{assetCategory},
            #{cycleType},
            #{nextGenerateTime},
            #{status},
            #{remark},
            #{createBy},
            #{createTime}
        )
    </insert>

    <!-- Update maintenance plan -->
    <update id="updateMaintPlan" parameterType="com.ruoyi.asset.domain.entity.AssetMaintPlan">
        UPDATE t_asset_maint_plan
        <set>
            <if test="planName != null">plan_name = #{planName},</if>
            <if test="projectId != null">project_id = #{projectId},</if>
            <if test="assetType != null">asset_type = #{assetType},</if>
            <if test="assetCategory != null">asset_category = #{assetCategory},</if>
            <if test="cycleType != null">cycle_type = #{cycleType},</if>
            <if test="nextGenerateTime != null">next_generate_time = #{nextGenerateTime},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- Delete maintenance plan by ID -->
    <delete id="deleteMaintPlanById" parameterType="java.lang.Long">
        DELETE FROM t_asset_maint_plan WHERE id = #{id}
    </delete>

    <!-- Batch delete maintenance plans -->
    <delete id="deleteMaintPlanByIds" parameterType="java.lang.Long">
        DELETE FROM t_asset_maint_plan WHERE id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- Select enabled plans that need to generate orders -->
    <select id="selectPlansForGeneration" resultType="com.ruoyi.asset.domain.entity.AssetMaintPlan">
        SELECT
            id,
            plan_name,
            project_id,
            asset_type,
            asset_category,
            cycle_type,
            next_generate_time,
            status,
            remark,
            create_by,
            create_time,
            update_by,
            update_time
        FROM t_asset_maint_plan
        WHERE status = 'ENABLED'
          AND next_generate_time IS NOT NULL
          AND next_generate_time &lt;= #{currentTime}
    </select>

    <!-- Update next generate time -->
    <update id="updateNextGenerateTime">
        UPDATE t_asset_maint_plan
        SET next_generate_time = #{nextTime}
        WHERE id = #{id}
    </update>

</mapper>
