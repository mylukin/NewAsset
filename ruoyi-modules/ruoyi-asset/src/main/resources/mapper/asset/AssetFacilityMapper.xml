<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.asset.mapper.AssetFacilityMapper">

    <!-- Result map for list view -->
    <resultMap id="AssetFacilityListResult" type="com.ruoyi.asset.domain.vo.AssetFacilityListVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="roomNo" column="room_no"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="originalValue" column="original_value"/>
        <result property="netValue" column="net_value"/>
        <result property="facilityType" column="facility_type"/>
        <result property="facilityTypeLabel" column="facility_type_label"/>
        <result property="installPosition" column="install_position"/>
        <result property="equipmentNo" column="equipment_no"/>
        <result property="maintOrg" column="maint_org"/>
        <result property="maintPhone" column="maint_phone"/>
    </resultMap>

    <!-- Result map for detail view -->
    <resultMap id="AssetFacilityDetailResult" type="com.ruoyi.asset.domain.vo.AssetFacilityDetailVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="assetType" column="asset_type"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="roomNo" column="room_no"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="ownershipType" column="ownership_type"/>
        <result property="ownershipTypeLabel" column="ownership_type_label"/>
        <result property="ownerOrg" column="owner_org"/>
        <result property="useDeptId" column="use_dept_id"/>
        <result property="useDeptName" column="use_dept_name"/>
        <result property="dutyUserId" column="duty_user_id"/>
        <result property="dutyUserName" column="duty_user_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="purchaseDate" column="purchase_date"/>
        <result property="startUseDate" column="start_use_date"/>
        <result property="originalValue" column="original_value"/>
        <result property="depreciationMethod" column="depreciation_method"/>
        <result property="depreciationMethodLabel" column="depreciation_method_label"/>
        <result property="netValue" column="net_value"/>
        <result property="brand" column="brand"/>
        <result property="model" column="model"/>
        <result property="supplier" column="supplier"/>
        <result property="warrantyExpireDate" column="warranty_expire_date"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="facilityType" column="facility_type"/>
        <result property="facilityTypeLabel" column="facility_type_label"/>
        <result property="installPosition" column="install_position"/>
        <result property="equipmentNo" column="equipment_no"/>
        <result property="maintOrg" column="maint_org"/>
        <result property="maintPhone" column="maint_phone"/>
    </resultMap>

    <!-- Query facility asset list with filters -->
    <select id="selectAssetFacilityList" parameterType="com.ruoyi.asset.mapper.AssetFacilityMapper$AssetFacilityQuery" resultMap="AssetFacilityListResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.status,
            ds.dict_label as status_label,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.room_no,
            a.location_desc,
            a.original_value,
            a.net_value,
            f.facility_type,
            dft.dict_label as facility_type_label,
            f.install_position,
            f.equipment_no,
            f.maint_org,
            f.maint_phone
        FROM t_asset a
        INNER JOIN t_asset_facility f ON a.id = f.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dft ON dft.dict_type = 'facility_type' AND dft.dict_value = f.facility_type
        WHERE a.del_flag = '0'
        AND a.asset_type = 'facility'
        <if test="projectId != null">
            AND a.project_id = #{projectId}
        </if>
        <if test="building != null and building != ''">
            AND a.building LIKE CONCAT('%', #{building}, '%')
        </if>
        <if test="floor != null and floor != ''">
            AND a.floor = #{floor}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        <if test="facilityType != null and facilityType != ''">
            AND f.facility_type = #{facilityType}
        </if>
        <if test="assetName != null and assetName != ''">
            AND a.asset_name LIKE CONCAT('%', #{assetName}, '%')
        </if>
        <if test="assetCode != null and assetCode != ''">
            AND a.asset_code LIKE CONCAT('%', #{assetCode}, '%')
        </if>
        <if test="equipmentNo != null and equipmentNo != ''">
            AND f.equipment_no LIKE CONCAT('%', #{equipmentNo}, '%')
        </if>
        <!-- Data scope filtering -->
        <if test="dataScope != null and dataScope != ''">
            ${dataScope}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- Query facility asset detail by ID -->
    <select id="selectAssetFacilityById" parameterType="java.lang.Long" resultMap="AssetFacilityDetailResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.asset_type,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.room_no,
            a.location_desc,
            a.ownership_type,
            dot.dict_label as ownership_type_label,
            a.owner_org,
            a.use_dept_id,
            d.dept_name as use_dept_name,
            a.duty_user_id,
            u.nick_name as duty_user_name,
            a.status,
            ds.dict_label as status_label,
            a.purchase_date,
            a.start_use_date,
            a.original_value,
            a.depreciation_method,
            ddm.dict_label as depreciation_method_label,
            a.net_value,
            a.brand,
            a.model,
            a.supplier,
            a.warranty_expire_date,
            a.remark,
            a.create_time,
            a.update_time,
            f.facility_type,
            dft.dict_label as facility_type_label,
            f.install_position,
            f.equipment_no,
            f.maint_org,
            f.maint_phone
        FROM t_asset a
        INNER JOIN t_asset_facility f ON a.id = f.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dept d ON a.use_dept_id = d.dept_id
        LEFT JOIN sys_user u ON a.duty_user_id = u.user_id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dot ON dot.dict_type = 'ownership_type' AND dot.dict_value = a.ownership_type
        LEFT JOIN sys_dict_data ddm ON ddm.dict_type = 'depreciation_method' AND ddm.dict_value = a.depreciation_method
        LEFT JOIN sys_dict_data dft ON dft.dict_type = 'facility_type' AND dft.dict_value = f.facility_type
        WHERE a.id = #{id}
        AND a.del_flag = '0'
    </select>

    <!-- Insert facility asset extension -->
    <insert id="insertAssetFacility" parameterType="com.ruoyi.asset.domain.entity.AssetFacility">
        INSERT INTO t_asset_facility (
            asset_id,
            facility_type,
            install_position,
            equipment_no,
            maint_org,
            maint_phone
        ) VALUES (
            #{assetId},
            #{facilityType},
            #{installPosition},
            #{equipmentNo},
            #{maintOrg},
            #{maintPhone}
        )
    </insert>

    <!-- Update facility asset extension -->
    <update id="updateAssetFacility" parameterType="com.ruoyi.asset.domain.entity.AssetFacility">
        UPDATE t_asset_facility
        <set>
            <if test="facilityType != null">facility_type = #{facilityType},</if>
            <if test="installPosition != null">install_position = #{installPosition},</if>
            <if test="equipmentNo != null">equipment_no = #{equipmentNo},</if>
            <if test="maintOrg != null">maint_org = #{maintOrg},</if>
            <if test="maintPhone != null">maint_phone = #{maintPhone},</if>
        </set>
        WHERE asset_id = #{assetId}
    </update>

    <!-- Delete facility asset extension by ID -->
    <delete id="deleteAssetFacilityById" parameterType="java.lang.Long">
        DELETE FROM t_asset_facility WHERE asset_id = #{id}
    </delete>

    <!-- Batch delete facility asset extensions -->
    <delete id="deleteAssetFacilityByIds" parameterType="java.lang.Long">
        DELETE FROM t_asset_facility WHERE asset_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- Result map for warranty expiring view -->
    <resultMap id="FacilityWarrantyExpiringResult" type="com.ruoyi.asset.domain.vo.FacilityWarrantyExpiringVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="facilityType" column="facility_type"/>
        <result property="facilityTypeLabel" column="facility_type_label"/>
        <result property="equipmentNo" column="equipment_no"/>
        <result property="maintOrg" column="maint_org"/>
        <result property="maintPhone" column="maint_phone"/>
        <result property="warrantyExpireDate" column="warranty_expire_date"/>
        <result property="daysRemaining" column="days_remaining"/>
    </resultMap>

    <!-- Query facilities with warranty expiring within specified days -->
    <select id="selectExpiringFacilities" resultMap="FacilityWarrantyExpiringResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            f.facility_type,
            dft.dict_label as facility_type_label,
            f.equipment_no,
            f.maint_org,
            f.maint_phone,
            a.warranty_expire_date,
            DATEDIFF(a.warranty_expire_date, CURDATE()) as days_remaining
        FROM t_asset a
        INNER JOIN t_asset_facility f ON a.id = f.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dict_data dft ON dft.dict_type = 'facility_type' AND dft.dict_value = f.facility_type
        WHERE a.del_flag = '0'
        AND a.asset_type = 'facility'
        AND a.warranty_expire_date IS NOT NULL
        AND a.warranty_expire_date >= CURDATE()
        AND a.warranty_expire_date &lt;= DATE_ADD(CURDATE(), INTERVAL #{daysAhead} DAY)
        <if test="projectId != null">
            AND a.project_id = #{projectId}
        </if>
        ORDER BY a.warranty_expire_date ASC
    </select>

</mapper>
