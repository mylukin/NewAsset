<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.asset.mapper.AssetOfficeMapper">

    <!-- Result map for list view -->
    <resultMap id="AssetOfficeListResult" type="com.ruoyi.asset.domain.vo.AssetOfficeListVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="originalValue" column="original_value"/>
        <result property="netValue" column="net_value"/>
        <result property="brand" column="brand"/>
        <result property="model" column="model"/>
        <result property="officeType" column="office_type"/>
        <result property="officeTypeLabel" column="office_type_label"/>
        <result property="workplaceNo" column="workplace_no"/>
        <result property="useUser" column="use_user"/>
        <result property="serialNo" column="serial_no"/>
        <result property="osInfo" column="os_info"/>
        <result property="configDesc" column="config_desc"/>
    </resultMap>

    <!-- Result map for detail view -->
    <resultMap id="AssetOfficeDetailResult" type="com.ruoyi.asset.domain.vo.AssetOfficeDetailVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="assetType" column="asset_type"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="roomNo" column="room_no"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="ownershipType" column="ownership_type"/>
        <result property="ownershipTypeLabel" column="ownership_type_label"/>
        <result property="ownerOrg" column="owner_org"/>
        <result property="useDeptId" column="use_dept_id"/>
        <result property="useDeptName" column="use_dept_name"/>
        <result property="dutyUserId" column="duty_user_id"/>
        <result property="dutyUserName" column="duty_user_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="purchaseDate" column="purchase_date"/>
        <result property="startUseDate" column="start_use_date"/>
        <result property="originalValue" column="original_value"/>
        <result property="depreciationMethod" column="depreciation_method"/>
        <result property="depreciationMethodLabel" column="depreciation_method_label"/>
        <result property="netValue" column="net_value"/>
        <result property="brand" column="brand"/>
        <result property="model" column="model"/>
        <result property="supplier" column="supplier"/>
        <result property="warrantyExpireDate" column="warranty_expire_date"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="officeType" column="office_type"/>
        <result property="officeTypeLabel" column="office_type_label"/>
        <result property="workplaceNo" column="workplace_no"/>
        <result property="useUser" column="use_user"/>
        <result property="serialNo" column="serial_no"/>
        <result property="osInfo" column="os_info"/>
        <result property="configDesc" column="config_desc"/>
    </resultMap>

    <!-- Query office asset list with filters -->
    <select id="selectAssetOfficeList" parameterType="com.ruoyi.asset.mapper.AssetOfficeMapper$AssetOfficeQuery" resultMap="AssetOfficeListResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.status,
            ds.dict_label as status_label,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.location_desc,
            a.original_value,
            a.net_value,
            a.brand,
            a.model,
            o.office_type,
            dot.dict_label as office_type_label,
            o.workplace_no,
            o.use_user,
            o.serial_no,
            o.os_info,
            o.config_desc
        FROM t_asset a
        INNER JOIN t_asset_office o ON a.id = o.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dot ON dot.dict_type = 'office_type' AND dot.dict_value = o.office_type
        WHERE a.del_flag = '0'
        AND a.asset_type = 'OFFICE'
        <if test="projectId != null">
            AND a.project_id = #{projectId}
        </if>
        <if test="useDeptId != null">
            AND a.use_dept_id = #{useDeptId}
        </if>
        <if test="dutyUserId != null">
            AND a.duty_user_id = #{dutyUserId}
        </if>
        <if test="officeType != null and officeType != ''">
            AND o.office_type = #{officeType}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        <if test="building != null and building != ''">
            AND a.building LIKE CONCAT('%', #{building}, '%')
        </if>
        <if test="floor != null and floor != ''">
            AND a.floor = #{floor}
        </if>
        <if test="assetName != null and assetName != ''">
            AND a.asset_name LIKE CONCAT('%', #{assetName}, '%')
        </if>
        <if test="assetCode != null and assetCode != ''">
            AND a.asset_code LIKE CONCAT('%', #{assetCode}, '%')
        </if>
        <if test="useUser != null and useUser != ''">
            AND o.use_user LIKE CONCAT('%', #{useUser}, '%')
        </if>
        <if test="workplaceNo != null and workplaceNo != ''">
            AND o.workplace_no LIKE CONCAT('%', #{workplaceNo}, '%')
        </if>
        <if test="serialNo != null and serialNo != ''">
            AND o.serial_no LIKE CONCAT('%', #{serialNo}, '%')
        </if>
        <!-- Data scope filtering -->
        <if test="dataScope != null and dataScope != ''">
            ${dataScope}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- Query office asset detail by ID -->
    <select id="selectAssetOfficeById" parameterType="java.lang.Long" resultMap="AssetOfficeDetailResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.asset_type,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.room_no,
            a.location_desc,
            a.ownership_type,
            dow.dict_label as ownership_type_label,
            a.owner_org,
            a.use_dept_id,
            d.dept_name as use_dept_name,
            a.duty_user_id,
            u.nick_name as duty_user_name,
            a.status,
            ds.dict_label as status_label,
            a.purchase_date,
            a.start_use_date,
            a.original_value,
            a.depreciation_method,
            ddm.dict_label as depreciation_method_label,
            a.net_value,
            a.brand,
            a.model,
            a.supplier,
            a.warranty_expire_date,
            a.remark,
            a.create_time,
            a.update_time,
            o.office_type,
            dot.dict_label as office_type_label,
            o.workplace_no,
            o.use_user,
            o.serial_no,
            o.os_info,
            o.config_desc
        FROM t_asset a
        INNER JOIN t_asset_office o ON a.id = o.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dept d ON a.use_dept_id = d.dept_id
        LEFT JOIN sys_user u ON a.duty_user_id = u.user_id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dow ON dow.dict_type = 'ownership_type' AND dow.dict_value = a.ownership_type
        LEFT JOIN sys_dict_data ddm ON ddm.dict_type = 'depreciation_method' AND ddm.dict_value = a.depreciation_method
        LEFT JOIN sys_dict_data dot ON dot.dict_type = 'office_type' AND dot.dict_value = o.office_type
        WHERE a.id = #{id}
        AND a.del_flag = '0'
    </select>

    <!-- Insert office asset extension -->
    <insert id="insertAssetOffice" parameterType="com.ruoyi.asset.domain.entity.AssetOffice">
        INSERT INTO t_asset_office (
            asset_id,
            office_type,
            workplace_no,
            use_user,
            serial_no,
            os_info,
            config_desc
        ) VALUES (
            #{assetId},
            #{officeType},
            #{workplaceNo},
            #{useUser},
            #{serialNo},
            #{osInfo},
            #{configDesc}
        )
    </insert>

    <!-- Update office asset extension -->
    <update id="updateAssetOffice" parameterType="com.ruoyi.asset.domain.entity.AssetOffice">
        UPDATE t_asset_office
        <set>
            <if test="officeType != null">office_type = #{officeType},</if>
            <if test="workplaceNo != null">workplace_no = #{workplaceNo},</if>
            <if test="useUser != null">use_user = #{useUser},</if>
            <if test="serialNo != null">serial_no = #{serialNo},</if>
            <if test="osInfo != null">os_info = #{osInfo},</if>
            <if test="configDesc != null">config_desc = #{configDesc},</if>
        </set>
        WHERE asset_id = #{assetId}
    </update>

    <!-- Delete office asset extension by ID -->
    <delete id="deleteAssetOfficeById" parameterType="java.lang.Long">
        DELETE FROM t_asset_office WHERE asset_id = #{id}
    </delete>

    <!-- Batch delete office asset extensions -->
    <delete id="deleteAssetOfficeByIds" parameterType="java.lang.Long">
        DELETE FROM t_asset_office WHERE asset_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- Query office condition statistics -->
    <select id="selectOfficeConditionStats" resultType="com.ruoyi.asset.domain.vo.OfficeConditionStatisticsVO">
        SELECT
            COUNT(*) as totalCount,
            COALESCE(SUM(a.original_value), 0) as totalOriginalValue,
            COALESCE(SUM(a.net_value), 0) as totalNetValue,
            SUM(CASE WHEN o.use_user IS NOT NULL AND o.use_user != '' THEN 1 ELSE 0 END) as assignedCount,
            SUM(CASE WHEN o.use_user IS NULL OR o.use_user = '' THEN 1 ELSE 0 END) as unassignedCount,
            SUM(CASE WHEN o.office_type = 'IT' THEN 1 ELSE 0 END) as itEquipmentCount,
            SUM(CASE WHEN o.office_type = 'FURNITURE' THEN 1 ELSE 0 END) as furnitureCount,
            SUM(CASE WHEN o.office_type NOT IN ('IT', 'FURNITURE') OR o.office_type IS NULL THEN 1 ELSE 0 END) as otherCount
        FROM t_asset a
        INNER JOIN t_asset_office o ON a.id = o.asset_id
        WHERE a.del_flag = '0'
        AND a.asset_type = 'OFFICE'
        <if test="projectId != null">AND a.project_id = #{projectId}</if>
        <if test="deptId != null">AND a.use_dept_id = #{deptId}</if>
    </select>

    <!-- Query department statistics for comparison -->
    <select id="selectDepartmentStats" resultType="com.ruoyi.asset.domain.vo.OfficeConditionStatisticsVO$DepartmentStatVO">
        SELECT
            d.dept_id as deptId,
            d.dept_name as deptName,
            COUNT(*) as totalCount,
            SUM(CASE WHEN o.office_type = 'IT' THEN 1 ELSE 0 END) as itEquipmentCount,
            SUM(CASE WHEN o.office_type = 'FURNITURE' THEN 1 ELSE 0 END) as furnitureCount,
            SUM(CASE WHEN o.office_type NOT IN ('IT', 'FURNITURE') OR o.office_type IS NULL THEN 1 ELSE 0 END) as otherCount,
            COALESCE(SUM(a.original_value), 0) as totalValue
        FROM t_asset a
        INNER JOIN t_asset_office o ON a.id = o.asset_id
        LEFT JOIN sys_dept d ON a.use_dept_id = d.dept_id
        WHERE a.del_flag = '0'
        AND a.asset_type = 'OFFICE'
        <if test="projectId != null">AND a.project_id = #{projectId}</if>
        GROUP BY d.dept_id, d.dept_name
        ORDER BY totalCount DESC
    </select>

</mapper>
