<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.asset.mapper.AssetHouseMapper">

    <!-- Result map for list view -->
    <resultMap id="AssetHouseListResult" type="com.ruoyi.asset.domain.vo.AssetHouseListVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="roomNo" column="room_no"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="buildingArea" column="building_area"/>
        <result property="innerArea" column="inner_area"/>
        <result property="houseType" column="house_type"/>
        <result property="houseTypeLabel" column="house_type_label"/>
        <result property="houseUsage" column="house_usage"/>
        <result property="houseUsageLabel" column="house_usage_label"/>
        <result property="currentUsage" column="current_usage"/>
        <result property="currentUser" column="current_user"/>
        <result property="rentTotal" column="rent_total"/>
    </resultMap>

    <!-- Result map for detail view -->
    <resultMap id="AssetHouseDetailResult" type="com.ruoyi.asset.domain.vo.AssetHouseDetailVO">
        <id property="id" column="id"/>
        <result property="assetCode" column="asset_code"/>
        <result property="assetName" column="asset_name"/>
        <result property="assetType" column="asset_type"/>
        <result property="projectId" column="project_id"/>
        <result property="projectName" column="project_name"/>
        <result property="building" column="building"/>
        <result property="floor" column="floor"/>
        <result property="roomNo" column="room_no"/>
        <result property="locationDesc" column="location_desc"/>
        <result property="ownershipType" column="ownership_type"/>
        <result property="ownershipTypeLabel" column="ownership_type_label"/>
        <result property="ownerOrg" column="owner_org"/>
        <result property="useDeptId" column="use_dept_id"/>
        <result property="useDeptName" column="use_dept_name"/>
        <result property="dutyUserId" column="duty_user_id"/>
        <result property="dutyUserName" column="duty_user_name"/>
        <result property="status" column="status"/>
        <result property="statusLabel" column="status_label"/>
        <result property="purchaseDate" column="purchase_date"/>
        <result property="startUseDate" column="start_use_date"/>
        <result property="originalValue" column="original_value"/>
        <result property="depreciationMethod" column="depreciation_method"/>
        <result property="depreciationAmount" column="depreciation_amount"/>
        <result property="netValue" column="net_value"/>
        <result property="brand" column="brand"/>
        <result property="model" column="model"/>
        <result property="supplier" column="supplier"/>
        <result property="warrantyExpireDate" column="warranty_expire_date"/>
        <result property="remark" column="remark"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="buildingArea" column="building_area"/>
        <result property="innerArea" column="inner_area"/>
        <result property="houseType" column="house_type"/>
        <result property="houseTypeLabel" column="house_type_label"/>
        <result property="houseUsage" column="house_usage"/>
        <result property="houseUsageLabel" column="house_usage_label"/>
        <result property="currentUsage" column="current_usage"/>
        <result property="currentUser" column="current_user"/>
        <result property="contractNo" column="contract_no"/>
        <result property="rentUnitPrice" column="rent_unit_price"/>
        <result property="rentTotal" column="rent_total"/>
    </resultMap>

    <!-- Query house asset list with filters -->
    <select id="selectAssetHouseList" parameterType="com.ruoyi.asset.mapper.AssetHouseMapper$AssetHouseQuery" resultMap="AssetHouseListResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.status,
            ds.dict_label as status_label,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.room_no,
            a.location_desc,
            h.building_area,
            h.inner_area,
            h.house_type,
            dht.dict_label as house_type_label,
            h.house_usage,
            dhu.dict_label as house_usage_label,
            h.current_usage,
            h.current_user,
            h.rent_total
        FROM t_asset a
        INNER JOIN t_asset_house h ON a.id = h.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dht ON dht.dict_type = 'house_type' AND dht.dict_value = h.house_type
        LEFT JOIN sys_dict_data dhu ON dhu.dict_type = 'house_usage' AND dhu.dict_value = h.house_usage
        WHERE a.del_flag = '0'
        AND a.asset_type = 'house'
        <if test="projectId != null">
            AND a.project_id = #{projectId}
        </if>
        <if test="building != null and building != ''">
            AND a.building LIKE CONCAT('%', #{building}, '%')
        </if>
        <if test="floor != null and floor != ''">
            AND a.floor = #{floor}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        <if test="houseType != null and houseType != ''">
            AND h.house_type = #{houseType}
        </if>
        <if test="houseUsage != null and houseUsage != ''">
            AND h.house_usage = #{houseUsage}
        </if>
        <if test="currentUsage != null and currentUsage != ''">
            AND h.current_usage = #{currentUsage}
        </if>
        <if test="minArea != null">
            AND h.building_area &gt;= #{minArea}
        </if>
        <if test="maxArea != null">
            AND h.building_area &lt;= #{maxArea}
        </if>
        <if test="assetName != null and assetName != ''">
            AND a.asset_name LIKE CONCAT('%', #{assetName}, '%')
        </if>
        <if test="assetCode != null and assetCode != ''">
            AND a.asset_code LIKE CONCAT('%', #{assetCode}, '%')
        </if>
        <!-- Data scope filtering -->
        <if test="dataScope != null and dataScope != ''">
            ${dataScope}
        </if>
        ORDER BY a.create_time DESC
    </select>

    <!-- Query house asset detail by ID -->
    <select id="selectAssetHouseById" parameterType="java.lang.Long" resultMap="AssetHouseDetailResult">
        SELECT
            a.id,
            a.asset_code,
            a.asset_name,
            a.asset_type,
            a.project_id,
            p.project_name,
            a.building,
            a.floor,
            a.room_no,
            a.location_desc,
            a.ownership_type,
            dot.dict_label as ownership_type_label,
            a.owner_org,
            a.use_dept_id,
            d.dept_name as use_dept_name,
            a.duty_user_id,
            u.nick_name as duty_user_name,
            a.status,
            ds.dict_label as status_label,
            a.purchase_date,
            a.start_use_date,
            a.original_value,
            a.depreciation_method,
            a.depreciation_amount,
            a.net_value,
            a.brand,
            a.model,
            a.supplier,
            a.warranty_expire_date,
            a.remark,
            a.create_by,
            a.create_time,
            a.update_by,
            a.update_time,
            h.building_area,
            h.inner_area,
            h.house_type,
            dht.dict_label as house_type_label,
            h.house_usage,
            dhu.dict_label as house_usage_label,
            h.current_usage,
            h.current_user,
            h.contract_no,
            h.rent_unit_price,
            h.rent_total
        FROM t_asset a
        INNER JOIN t_asset_house h ON a.id = h.asset_id
        LEFT JOIN sys_project p ON a.project_id = p.id
        LEFT JOIN sys_dept d ON a.use_dept_id = d.dept_id
        LEFT JOIN sys_user u ON a.duty_user_id = u.user_id
        LEFT JOIN sys_dict_data ds ON ds.dict_type = 'asset_status' AND ds.dict_value = a.status
        LEFT JOIN sys_dict_data dot ON dot.dict_type = 'ownership_type' AND dot.dict_value = a.ownership_type
        LEFT JOIN sys_dict_data dht ON dht.dict_type = 'house_type' AND dht.dict_value = h.house_type
        LEFT JOIN sys_dict_data dhu ON dhu.dict_type = 'house_usage' AND dhu.dict_value = h.house_usage
        WHERE a.id = #{id}
        AND a.del_flag = '0'
    </select>

    <!-- Insert house asset extension -->
    <insert id="insertAssetHouse" parameterType="com.ruoyi.asset.domain.entity.AssetHouse">
        INSERT INTO t_asset_house (
            asset_id,
            building_area,
            inner_area,
            house_type,
            house_usage,
            current_usage,
            current_user,
            contract_no,
            rent_unit_price,
            rent_total
        ) VALUES (
            #{assetId},
            #{buildingArea},
            #{innerArea},
            #{houseType},
            #{houseUsage},
            #{currentUsage},
            #{currentUser},
            #{contractNo},
            #{rentUnitPrice},
            #{rentTotal}
        )
    </insert>

    <!-- Update house asset extension -->
    <update id="updateAssetHouse" parameterType="com.ruoyi.asset.domain.entity.AssetHouse">
        UPDATE t_asset_house
        <set>
            <if test="buildingArea != null">building_area = #{buildingArea},</if>
            <if test="innerArea != null">inner_area = #{innerArea},</if>
            <if test="houseType != null">house_type = #{houseType},</if>
            <if test="houseUsage != null">house_usage = #{houseUsage},</if>
            <if test="currentUsage != null">current_usage = #{currentUsage},</if>
            <if test="currentUser != null">current_user = #{currentUser},</if>
            <if test="contractNo != null">contract_no = #{contractNo},</if>
            <if test="rentUnitPrice != null">rent_unit_price = #{rentUnitPrice},</if>
            <if test="rentTotal != null">rent_total = #{rentTotal},</if>
        </set>
        WHERE asset_id = #{assetId}
    </update>

    <!-- Delete house asset extension by ID -->
    <delete id="deleteAssetHouseById" parameterType="java.lang.Long">
        DELETE FROM t_asset_house WHERE asset_id = #{id}
    </delete>

    <!-- Batch delete house asset extensions -->
    <delete id="deleteAssetHouseByIds" parameterType="java.lang.Long">
        DELETE FROM t_asset_house WHERE asset_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- Result map for statistics -->
    <resultMap id="HouseStatisticsResult" type="com.ruoyi.asset.domain.vo.HouseStatisticsVO">
        <result property="totalCount" column="total_count"/>
        <result property="selfUseCount" column="self_use_count"/>
        <result property="rentCount" column="rent_count"/>
        <result property="idleCount" column="idle_count"/>
        <result property="totalBuildingArea" column="total_building_area"/>
        <result property="selfUseArea" column="self_use_area"/>
        <result property="rentArea" column="rent_area"/>
        <result property="idleArea" column="idle_area"/>
        <result property="totalRentIncome" column="total_rent_income"/>
        <result property="inUseCount" column="in_use_count"/>
        <result property="maintainingCount" column="maintaining_count"/>
        <result property="pendingDisposalCount" column="pending_disposal_count"/>
    </resultMap>

    <!-- Get house asset statistics using efficient SQL aggregation -->
    <select id="selectHouseStatistics" resultMap="HouseStatisticsResult">
        SELECT
            COUNT(*) as total_count,
            SUM(CASE WHEN h.current_usage = 'self' THEN 1 ELSE 0 END) as self_use_count,
            SUM(CASE WHEN h.current_usage = 'rent' THEN 1 ELSE 0 END) as rent_count,
            SUM(CASE WHEN h.current_usage = 'idle' OR h.current_usage IS NULL THEN 1 ELSE 0 END) as idle_count,
            COALESCE(SUM(h.building_area), 0) as total_building_area,
            COALESCE(SUM(CASE WHEN h.current_usage = 'self' THEN h.building_area ELSE 0 END), 0) as self_use_area,
            COALESCE(SUM(CASE WHEN h.current_usage = 'rent' THEN h.building_area ELSE 0 END), 0) as rent_area,
            COALESCE(SUM(CASE WHEN h.current_usage = 'idle' OR h.current_usage IS NULL THEN h.building_area ELSE 0 END), 0) as idle_area,
            COALESCE(SUM(CASE WHEN h.current_usage = 'rent' THEN h.rent_total ELSE 0 END), 0) as total_rent_income,
            SUM(CASE WHEN a.status = 'in_use' THEN 1 ELSE 0 END) as in_use_count,
            SUM(CASE WHEN a.status = 'maintaining' THEN 1 ELSE 0 END) as maintaining_count,
            SUM(CASE WHEN a.status = 'pending_disposal' THEN 1 ELSE 0 END) as pending_disposal_count
        FROM t_asset a
        INNER JOIN t_asset_house h ON a.id = h.asset_id
        WHERE a.del_flag = '0'
        AND a.asset_type = 'house'
        <if test="projectId != null">
            AND a.project_id = #{projectId}
        </if>
    </select>

</mapper>
